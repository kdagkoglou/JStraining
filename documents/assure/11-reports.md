# Assure reports

Most reports use the same process:

1. The URL is `/report/<name>/`
1. Express.js routes to `/routes/report.js`
1. The router checks whether the user has access to the report
1. The router retrieves all parameters initialises the object defined in `/lib/report-<name>`
1. The `.run()` method is called
1. It returns a set of data, a chart (optional), and linking information to click back to the test list (optional)
1. The router returns either an HTML, JSON, CSV, or SVG response according to the calling process and `format` parameter.

HTML is rendered by the `report-generic.dot` template view.

Reports return a data object similar to the following format:

```js
{
  $total: {
    fr: {
      metric2_1: 1,
      metric2_2: 2,
      metric2_3: 3,
      $total: 6
    }
    uk: {
      metric2_1: 3,
      metric2_2: 2,
      metric2_3: 1,
      $total: 6
    },
    $all: {
      metric2_1: 4,
      metric2_2: 4,
      metric2_3: 4,
      $total: 12
    }
  },
  $metric1_1: {
    fr: {
      metric2_1: 0,
      metric2_2: 1,
      metric2_3: 2,
      $total: 3
    }
    uk: {
      metric2_1: 2,
      metric2_2: 1,
      metric2_3: 0,
      $total: 3
    },
    $all: {
      metric2_1: 2,
      metric2_2: 2,
      metric2_3: 2,
      $total: 6
    }
  },
  $metric1_2: {
    fr: {
      metric2_1: 0,
      metric2_2: 0,
      metric2_3: 0,
      $total: 0
    }
    uk: {
      metric2_1: 1,
      metric2_2: 2,
      metric2_3: 3,
      $total: 6
    },
    $all: {
      metric2_1: 1,
      metric2_2: 2,
      metric2_3: 3,
      $total: 6
    }
  }
}
```

*(`$all` sub-total values are omitted when a single country is chosen)*

The `report-generic.dot` template creates HTML by:

1. Removing the country column if it is unnecessary.
1. Removing any row where the total is zero.
1. Removing any column where the total is zero.
1. Ensuring table `rowspan` attributes are correctly set.
1. Cropping any table with more than 200 rows.

In most cases, creating a new report means:

1. A new object in `/lib` is created with a single `.run(callback)` method.
1. A new help file is created named `/src/html/help-report-<name>-en.dot`.

In some cases, `/routes/report.js` and `report-generic.dot` are updated to add or modify filters for the new report.


## Custom reports

The following reports have their own router, `lib`, and view template code because they do not follow the typical report format.


### Ad scanner

Shows banner, landing, or payment page images encountered for countries, networks, and service types over the past 28 days (up to midnight of the day before). Note that some companies can have their images blocked in the report.

The report relies on `test` collection data:

1. `imgbanner` - presumed to be the first image with a name or comment containing 'ad' or 'banner'
1. `imgpreland` - presumed to be the first image with a name or comment containing 'land' that is not a banner
1. `imglanding` - presumed to be the last image with a name or comment containing 'land' that is not a banner

All are either `null` or point to the `_id` of an item in the `asset` collection and `imgpreland` and `imglanding` can be the same image.

The report searches for images by type according to the filters then groups by the fuzzy hash. Up to 200 results are returned which are placed as a data object on the page. These are revealed as the user scrolls down, but only the images are loaded - there is no additional database search.


### Market insight

Market insight is effectively a range of reports generated in a similar way to standard reports but placed on a single page.


### Mobile operator

Mobile operator is effectively a range of reports generated in a similar way to standard reports but placed on a single page.


### Client operations

Client operations shows client activity over a period and assigns a quality rating percentage. This is based on the assumption that at least 100 tests to 50 different URLs are completed per month. It is there compared against a long-term average.

A similar process is used to standard reports but a unique HTML table is generated by the report object.


### Brand status

Brand status shows how many times client brands are encountered during whole months over a period.

A similar process is used to standard reports but a unique HTML table is generated by the report object.


### Market performance

Market performance shows the client operations, creator, and operations report on a single page. Each is generated using the Assure API to fetch the whole HTML page. The chart and table are then extracted when available so they can be placed into the template.


### Export

The export report wraps data from several reports into a single page which can be saved as a file and sent to clients. While this file is HTML, it can be viewed offline, looks like a PDF, but has the benefits of responsive design and a small file size.

Various charts and tables are extracted from other reports using the Assure API to fetch the whole HTML page. The `report-export-preview.dot` template shows these items within a single self-contained HTML file which inlines all CSS, images, and other external assets. This is shown in an iframe so the analyst can:

* show or hide any page. This toggles a `removed` class on the `<article>` element used for each slide/page.
* add custom content using a simple markdown editor. Although any HTML element can be edited by setting the `contenteditable` attribute, this led to issues when analysts copied and pasted from Microsoft Word or other rich-text applications. The markdown editor forces plain text, but simple headings, lists, styling, and links can be defined, copied, and pasted.
* save the file.

The resulting file is generated by extracting the HTML between the `<head>` and `<main>` elements, placing into a string, using regular expressions to optimise, and adding as a data URI to the download link (which has a `download` attribute set). The file contains all assets, is minified, and does not contain JavaScript. It also contains printer-friendly CSS.


### Mobile operator export

The mobile operator export generates a range of data which it places into a Microsoft Excel template using [`xlsx-populate`](https://www.npmjs.com/package/xlsx-populate). While this is a reliable library, processing occurs in a separate worker thread to ensure a timeout can be implemented and any issues do not cause Assure to crash.

The resulting data is returned as an Excel file which can be downloaded.
